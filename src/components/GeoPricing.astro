---
// GeoPricing Component - Displays pricing based on visitor location
// Automatically detects US vs Canada and shows appropriate currency

interface Props {
	usdPrice: number;
	cadPrice: number;
	usdLabel?: string;
	cadLabel?: string;
	showCurrencyToggle?: boolean;
}

const { 
	usdPrice, 
	cadPrice, 
	usdLabel = "USD", 
	cadLabel = "CAD",
	showCurrencyToggle = true 
} = Astro.props;
---

<div class="geo-pricing" data-usd-price={usdPrice} data-cad-price={cadPrice}>
	<div class="pricing-display">
		<span class="price-formatted">${usdPrice.toFixed(2)} {usdLabel} per month</span>
	</div>
	{showCurrencyToggle && (
		<div class="currency-toggle">
			<button class="currency-btn active" data-currency="USD" aria-label="Show price in USD">
				USD
			</button>
			<button class="currency-btn" data-currency="CAD" aria-label="Show price in CAD">
				CAD
			</button>
		</div>
	)}
</div>

<script>
	// Geo-location detection and pricing update
	(function() {
		// Wait for DOM to be ready
		function init() {
			const pricingElements = document.querySelectorAll('.geo-pricing');
			
			if (pricingElements.length === 0) {
				// Elements not found yet, try again after a short delay
				setTimeout(init, 100);
				return;
			}
			
			// Function to update pricing display
			function updatePricing(element, currency) {
				const usdPrice = parseFloat(element.getAttribute('data-usd-price') || '0');
				const cadPrice = parseFloat(element.getAttribute('data-cad-price') || '0');
				const priceFormatted = element.querySelector('.price-formatted');
				const currencyButtons = element.querySelectorAll('.currency-btn');
				
				if (currency === 'CAD') {
					if (priceFormatted) {
						priceFormatted.textContent = `$${cadPrice.toFixed(2)} CAD per month`;
					}
				} else {
					if (priceFormatted) {
						priceFormatted.textContent = `$${usdPrice.toFixed(2)} USD per month`;
					}
				}
				
				// Update button states
				currencyButtons.forEach(btn => {
					if (btn.getAttribute('data-currency') === currency) {
						btn.classList.add('active');
					} else {
						btn.classList.remove('active');
					}
				});
			}
		
		// Update inline price spans
		function updateInlinePrices(currency) {
			const inlinePrices = document.querySelectorAll('.geo-price-inline');
			inlinePrices.forEach(span => {
				const usdPrice = parseFloat(span.getAttribute('data-usd-price') || '0');
				const cadPrice = parseFloat(span.getAttribute('data-cad-price') || '0');
				if (currency === 'CAD') {
					span.textContent = '$' + cadPrice.toLocaleString('en-CA');
				} else {
					span.textContent = '$' + usdPrice.toLocaleString('en-US');
				}
			});
		}

		// Update inline percentage spans
		function updateInlinePercentages(currency) {
			const inlinePercentages = document.querySelectorAll('.geo-percentage-inline');
			inlinePercentages.forEach(span => {
				const usdPercent = span.getAttribute('data-usd-percent') || '0';
				const cadPercent = span.getAttribute('data-cad-percent') || '0';
				if (currency === 'CAD') {
					span.textContent = cadPercent + '%';
				} else {
					span.textContent = usdPercent + '%';
				}
			});
		}
		
		// Apply currency to all elements
		function applyCurrency(currency) {
			pricingElements.forEach(element => {
				updatePricing(element, currency);
			});
			updateInlinePrices(currency);
			updateInlinePercentages(currency);
		}
		
		// Detect country from browser language
		function detectFromLanguage() {
			const lang = navigator.language || navigator.userLanguage || 'en-US';
			const langLower = lang.toLowerCase();
			
			// Only check for explicit Canadian locales (en-CA, fr-CA)
			// Don't assume French means Canada (could be France, Belgium, etc.)
			if (langLower.includes('-ca') || langLower === 'en-ca' || langLower === 'fr-ca') {
				return 'CA';
			}
			
			// Check for US locales
			if (langLower.includes('-us') || langLower === 'en-us') {
				return 'US';
			}
			
			return null;
		}
		
		// Detect country from timezone
		function detectFromTimezone() {
			try {
				const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
				// Canadian timezones
				const canadianTimezones = [
					'America/Toronto', 'America/Vancouver', 'America/Edmonton',
					'America/Winnipeg', 'America/Halifax', 'America/St_Johns',
					'America/Montreal', 'America/Regina', 'America/Yellowknife',
					'America/Whitehorse', 'America/Dawson', 'America/Inuvik',
					'America/Glace_Bay', 'America/Moncton', 'America/Thunder_Bay',
					'America/Iqaluit', 'America/Rankin_Inlet', 'America/Resolute'
				];
				if (canadianTimezones.includes(timezone)) {
					return 'CA';
				}
			} catch (e) {
				// Timezone detection failed
			}
			return null;
		}
		
		// Detect location using IP geolocation (multiple APIs as fallback)
		async function detectFromIP() {
			const apis = [
				{ url: 'https://ipapi.co/json/', field: 'country_code' },
				{ url: 'https://ip-api.com/json/?fields=countryCode', field: 'countryCode' },
				{ url: 'https://api.country.is/', field: 'country' },
				{ url: 'https://ipapi.co/country/', field: null, textResponse: true }
			];
			
			for (const api of apis) {
				try {
					// Create timeout controller for browser compatibility
					const controller = new AbortController();
					const timeoutId = setTimeout(() => controller.abort(), 5000); // Increased timeout
					
					const response = await fetch(api.url, {
						method: 'GET',
						headers: { 'Accept': 'application/json' },
						signal: controller.signal
					});
					
					clearTimeout(timeoutId);
					
					if (response.ok) {
						let country;
						
						if (api.textResponse) {
							// Handle text response (ipapi.co/country/ returns just "US" or "CA")
							country = (await response.text()).trim();
						} else {
							const data = await response.json();
							country = data[api.field];
						}
						
						// Normalize country code
						country = country?.toUpperCase();
						
						if (country === 'CA' || country === 'US') {
							return country;
						}
					}
				} catch (error) {
					// Try next API
					continue;
				}
			}
			
			return null;
		}
		
		// Main detection function with multiple fallbacks
		async function detectLocation() {
			// Method 1: IP geolocation (most reliable - prioritize this)
			// Check IP first, as it reflects current location (including VPN)
			const ipCountry = await detectFromIP();
			if (ipCountry) {
				// Update saved preference to match current IP location
				const currency = ipCountry === 'CA' ? 'CAD' : 'USD';
				localStorage.setItem('preferredCurrency', currency);
				return ipCountry;
			}
			
			// Method 2: Check localStorage preference (only if IP detection failed)
			const savedCurrency = localStorage.getItem('preferredCurrency');
			if (savedCurrency === 'USD' || savedCurrency === 'CAD') {
				return savedCurrency === 'CAD' ? 'CA' : 'US';
			}
			
			// Method 3: Timezone detection (only if IP fails)
			const tzCountry = detectFromTimezone();
			if (tzCountry) {
				return tzCountry;
			}
			
			// Method 4: Browser language (only if IP and timezone fail)
			const langCountry = detectFromLanguage();
			if (langCountry) {
				return langCountry;
			}
			
			// Default to US if all methods fail
			return 'US';
		}
		
		// Manual currency toggle
		pricingElements.forEach(element => {
			const buttons = element.querySelectorAll('.currency-btn');
			buttons.forEach(btn => {
				btn.addEventListener('click', () => {
					const currency = btn.getAttribute('data-currency');
					applyCurrency(currency);
					// Store preference in localStorage
					localStorage.setItem('preferredCurrency', currency);
					// Update percentages when manually toggled
					updateInlinePercentages(currency);
				});
			});
		});
		
		// Initialize pricing on page load
		detectLocation().then(country => {
			const currency = country === 'CA' ? 'CAD' : 'USD';
			applyCurrency(currency);
		}).catch(error => {
			// Fallback to USD on any error
			console.warn('[GeoPricing] Currency detection failed, defaulting to USD');
			applyCurrency('USD');
		});
		}
		
		// Start initialization
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', init);
		} else {
			init();
		}
	})();
</script>

<style>
	.geo-pricing {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
	}

	.pricing-display {
		display: flex;
		align-items: baseline;
		gap: 0.5rem;
	}

	.price-formatted {
		font-size: 2rem;
		font-weight: 700;
		color: var(--color-orange);
		white-space: nowrap;
	}

	.currency-toggle {
		display: flex;
		gap: 0.5rem;
		background: var(--color-bg-light);
		padding: 0.25rem;
		border-radius: 5px;
	}

	.currency-btn {
		padding: 0.5rem 1rem;
		border: none;
		background: transparent;
		color: var(--color-text-light);
		font-weight: 500;
		cursor: pointer;
		border-radius: 3px;
		transition: all 0.3s ease;
		font-family: inherit;
	}

	.currency-btn:hover {
		background: rgba(255, 132, 39, 0.1);
		color: var(--color-orange);
	}

	.currency-btn.active {
		background: var(--color-orange);
		color: #fff;
	}

	@media (max-width: 768px) {
		.price-formatted {
			font-size: 1.5rem;
		}

		.currency-btn {
			padding: 0.4rem 0.8rem;
			font-size: 0.9rem;
		}
	}
</style>

